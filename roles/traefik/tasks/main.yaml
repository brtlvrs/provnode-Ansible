---
- name: display custom variables
  #-- debug task to display custom created variables
  tags:
  - always
  debug:
    var: "{{ item }}"
    verbosity: 1
  loop:
  - "gv"
  - "trfk"

- name: "stop treafik container"
  tags:
    - never
    - stop
  community.docker.docker_container:
    name: "traefik"
    state: stopped
    container_default_behavior: no_defaults

- name: "remove treafik container"
  tags:
    - never
    - rm
  community.docker.docker_container:
    name: "traefik"
    state: absent    
    container_default_behavior: no_defaults

- name: template traefik.toml
  tags:
    - run
    - never
  ansible.builtin.template:
    src: "{{item}}.j2"
    dest: "{{gv.projectlocation}}/traefik/{{item}}"
    force: yes
  loop:
    - traefik.toml

- name: "run treafik container"
  tags:
    - never
    - run
    - run_only
  community.docker.docker_container:
    name: "traefik"
    image: "traefik:v2.4"
    hostname: "traefik"
    domainname: "{{gv.domain}}"
    ports:
      - 80:80
      - 443:443
    state: started
    recreate: yes    
    network_mode: "{{gv.networks.proxy.name}}"
    networks: 
      - name: "{{gv.networks.proxy.name}}"
    container_default_behavior: no_defaults
    detach: yes
    cleanup: yes
    labels:
      "traefik.enable" : "true"
      "traefik.http.routers.traefik.entrypoints" : "web"
      "traefik.http.routers.traefik.rule" : "Host(`lab.brtlvrs.lab`)"
      "traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme" : "https"
      "traefik.http.routers.traefik.middlewares" : "traefik-https-redirect"
      "traefik.http.routers.traefik-secure.entrypoints" : "websecure"
      "traefik.http.routers.traefik-secure.rule" : "Host(`lab.brtlvrs.lab`)"
      "traefik.http.routers.traefik-secure.tls" : "true"
      "traefik.http.routers.traefik-secure.tls.certresolver" : "letsencrypt"
      "traefik.http.routers.traefik-secure.service" : "api@internal"
  #    "traefik.http.routers.traefik-secure.middlewares" : "traefik-auth"
    restart_policy: "unless-stopped"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "{{gv.projectlocation}}/traefik/traefik.yaml:/etc/traefik/traefik.yaml:ro"
      - "{{gv.projectlocation}}/traefik/dynamic/:/etc/traefik/dynamic/"
      - "{{gv.projectlocation}}/traefik/log/:/log/"
      - "{{gv.projectlocation}}/traefik/acme.json:/etc/traefik/acme.json"
      - "{{gv.projectlocation}}/traefik/default.pem:/certs/default.pem:ro"
      - "{{gv.projectlocation}}/traefik/default.key:/run/secrets/default.key:ro"



